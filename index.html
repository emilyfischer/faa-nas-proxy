<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAS Status Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-blue-900 text-white min-h-screen">
  <div id="app"></div>

  <script type="module">
    const API_URL = 'https://faa-nas-proxy.vercel.app/api/nas-proxy';
    
    // Airport coordinates for weather lookup
    const AIRPORT_COORDS = {
      'ORD': { lat: 41.9742, lon: -87.9073, name: "Chicago O'Hare" },
      'JFK': { lat: 40.6413, lon: -73.7781, name: "JFK New York" },
      'LAX': { lat: 33.9416, lon: -118.4085, name: "Los Angeles" },
      'ATL': { lat: 33.6407, lon: -84.4277, name: "Atlanta" },
      'DFW': { lat: 32.8998, lon: -97.0403, name: "Dallas/Fort Worth" },
      'DEN': { lat: 39.8561, lon: -104.6737, name: "Denver" },
      'SFO': { lat: 37.6213, lon: -122.3790, name: "San Francisco" },
      'LAS': { lat: 36.0840, lon: -115.1537, name: "Las Vegas" },
      'PHX': { lat: 33.4352, lon: -112.0101, name: "Phoenix" },
      'MIA': { lat: 25.7959, lon: -80.2870, name: "Miami" },
      'BOS': { lat: 42.3656, lon: -71.0096, name: "Boston" },
      'SEA': { lat: 47.4502, lon: -122.3088, name: "Seattle" },
      'EWR': { lat: 40.6895, lon: -74.1745, name: "Newark" },
      'MCO': { lat: 28.4312, lon: -81.3081, name: "Orlando" },
      'CLT': { lat: 35.2144, lon: -80.9473, name: "Charlotte" }
    };
    
    let airports = [];
    let weather = {};
    let loading = true;
    let error = null;
    let filter = 'all';
    let searchQuery = '';
    let favorites = [];
    let lastUpdate = null;

    function getSeverity(airport) {
      if (!airport.status) return 'normal';
      if (airport.status.closureBegin || airport.status.groundStop) return 'severe';
      if (airport.status.groundDelay || airport.status.avgDelay) return 'moderate';
      return 'normal';
    }

    async function fetchWeather(iata) {
      const coords = AIRPORT_COORDS[iata];
      if (!coords) return null;
      
      try {
        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current=temperature_2m,wind_speed_10m,weather_code&temperature_unit=fahrenheit&wind_speed_unit=mph`
        );
        const data = await response.json();
        return {
          temp: Math.round(data.current.temperature_2m),
          wind: Math.round(data.current.wind_speed_10m),
          code: data.current.weather_code
        };
      } catch (err) {
        return null;
      }
    }

    function getWeatherDescription(code) {
      if (code === 0) return '‚òÄÔ∏è Clear';
      if (code <= 3) return '‚õÖ Partly Cloudy';
      if (code <= 49) return 'üå´Ô∏è Fog';
      if (code <= 69) return 'üåßÔ∏è Rain';
      if (code <= 79) return 'üå®Ô∏è Snow';
      if (code <= 99) return '‚õàÔ∏è Thunderstorm';
      return 'üå§Ô∏è Unknown';
    }

    async function fetchNASData() {
      try {
        loading = true;
        error = null;
        render();
        
        console.log('Fetching from:', API_URL);
        const response = await fetch(API_URL);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        console.log('Got XML data, length:', text.length);
        
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, 'text/xml');
        
        const parseError = xml.querySelector('parsererror');
        if (parseError) {
          throw new Error('XML parse error');
        }
        
        const airportData = [];
        
        // Parse Airport Closures
        const closures = xml.querySelectorAll('Airport_Closure_List Airport');
        closures.forEach(airport => {
          const iata = airport.querySelector('ARPT')?.textContent || '';
          airportData.push({
            IATA: iata,
            name: AIRPORT_COORDS[iata]?.name || '',
            status: {
              avgDelay: null,
              groundDelay: null,
              groundStop: null,
              closureBegin: airport.querySelector('Start')?.textContent || null,
              closureEnd: airport.querySelector('Reopen')?.textContent || null,
              reason: airport.querySelector('Reason')?.textContent || null
            }
          });
        });
        
        // Parse Ground Delays
        const groundDelays = xml.querySelectorAll('Ground_Delay_List Ground_Delay');
        groundDelays.forEach(delay => {
          const iata = delay.querySelector('ARPT')?.textContent || '';
          airportData.push({
            IATA: iata,
            name: AIRPORT_COORDS[iata]?.name || '',
            status: {
              avgDelay: delay.querySelector('Avg')?.textContent || null,
              groundDelay: delay.querySelector('Reason')?.textContent || null,
              groundStop: null,
              closureBegin: null,
              closureEnd: null,
              reason: delay.querySelector('Reason')?.textContent || null
            }
          });
        });
        
        // Parse Ground Stops
        const groundStops = xml.querySelectorAll('Ground_Stop_List Ground_Stop');
        groundStops.forEach(stop => {
          const iata = stop.querySelector('ARPT')?.textContent || '';
          airportData.push({
            IATA: iata,
            name: AIRPORT_COORDS[iata]?.name || '',
            status: {
              avgDelay: null,
              groundDelay: null,
              groundStop: stop.querySelector('Reason')?.textContent || null,
              closureBegin: null,
              closureEnd: null,
              reason: stop.querySelector('Reason')?.textContent || null
            }
          });
        });
        
        // Parse General Delays
        const delays = xml.querySelectorAll('Arrival_Departure_Delay_List Delay');
        delays.forEach(delay => {
          const iata = delay.querySelector('ARPT')?.textContent || '';
          airportData.push({
            IATA: iata,
            name: delay.querySelector('Name')?.textContent || AIRPORT_COORDS[iata]?.name || '',
            status: {
              avgDelay: delay.querySelector('Min')?.textContent ? 
                `${delay.querySelector('Min')?.textContent} - ${delay.querySelector('Max')?.textContent}` : null,
              groundDelay: null,
              groundStop: null,
              closureBegin: null,
              closureEnd: null,
              reason: delay.querySelector('Reason')?.textContent || null
            }
          });
        });
        
        console.log('Successfully parsed airports:', airportData.length);
        airports = airportData;
        
        // Fetch weather for airports
        const uniqueIatas = [...new Set(airportData.map(a => a.IATA))];
        for (const iata of uniqueIatas) {
          if (AIRPORT_COORDS[iata]) {
            weather[iata] = await fetchWeather(iata);
          }
        }
        
        lastUpdate = new Date();
        loading = false;
        render();
      } catch (err) {
        console.error('Fetch error:', err);
        error = '‚ö†Ô∏è Failed to load live data: ' + err.message;
        loading = false;
        render();
      }
    }

    function toggleFavorite(iata) {
      if (favorites.includes(iata)) {
        favorites = favorites.filter(f => f !== iata);
      } else {
        favorites.push(iata);
      }
      render();
    }

    function getFilteredAirports() {
      if (!airports.length) return [];
      
      let filtered = [...airports];
      
      // Apply severity filter
      if (filter === 'severe') {
        filtered = filtered.filter(a => getSeverity(a) === 'severe');
      } else if (filter === 'moderate') {
        filtered = filtered.filter(a => getSeverity(a) === 'moderate');
      } else if (filter === 'normal') {
        filtered = filtered.filter(a => getSeverity(a) === 'normal');
      } else if (filter === 'favorites') {
        filtered = filtered.filter(a => favorites.includes(a.IATA));
      }
      
      // Apply search
      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filtered = filtered.filter(a => 
          a.IATA.toLowerCase().includes(query) || 
          a.name.toLowerCase().includes(query)
        );
      }
      
      // Sort: favorites first, then by severity, then alphabetically
      filtered.sort((a, b) => {
        const aFav = favorites.includes(a.IATA);
        const bFav = favorites.includes(b.IATA);
        if (aFav && !bFav) return -1;
        if (!aFav && bFav) return 1;
        
        const severityOrder = { severe: 0, moderate: 1, normal: 2 };
        const aSev = severityOrder[getSeverity(a)];
        const bSev = severityOrder[getSeverity(b)];
        if (aSev !== bSev) return aSev - bSev;
        
        return a.IATA.localeCompare(b.IATA);
      });
      
      return filtered;
    }

    function render() {
      const filteredAirports = getFilteredAirports();
      const severeCount = airports.filter(a => getSeverity(a) === 'severe').length;
      const moderateCount = airports.filter(a => getSeverity(a) === 'moderate').length;

      document.getElementById('app').innerHTML = `
        <!-- Header -->
        <div class="bg-blue-950 shadow-lg">
          <div class="max-w-4xl mx-auto px-6 py-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h1 class="text-3xl font-bold tracking-tight">Airport Status</h1>
                <p class="text-blue-300 text-sm mt-1">
                  ${lastUpdate ? `Updated ${lastUpdate.toLocaleTimeString()}` : 'Loading...'}
                </p>
              </div>
              <button
                onclick="window.refreshData()"
                ${loading ? 'disabled' : ''}
                class="bg-blue-600 hover:bg-blue-500 p-3 rounded-full transition-all disabled:opacity-50"
              >
                <svg class="w-5 h-5 ${loading ? 'animate-spin' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              </button>
            </div>
            
            <!-- Search Bar -->
            <div class="relative">
              <input
                type="text"
                placeholder="Search by airport code or name..."
                value="${searchQuery}"
                oninput="window.setSearch(this.value)"
                class="w-full bg-blue-900 text-white placeholder-blue-400 px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <svg class="absolute right-4 top-3.5 w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Filter Pills -->
        <div class="max-w-4xl mx-auto px-6 py-4">
          <div class="flex gap-2 overflow-x-auto pb-2">
            <button
              onclick="window.setFilter('all')"
              class="px-5 py-2 rounded-full font-medium whitespace-nowrap transition-all ${
                filter === 'all' ? 'bg-white text-blue-900' : 'bg-blue-800 hover:bg-blue-700'
              }"
            >
              All (${airports.length})
            </button>
            ${favorites.length > 0 ? `
              <button
                onclick="window.setFilter('favorites')"
                class="px-5 py-2 rounded-full font-medium whitespace-nowrap transition-all ${
                  filter === 'favorites' ? 'bg-white text-blue-900' : 'bg-blue-800 hover:bg-blue-700'
                }"
              >
                ‚≠ê Favorites (${favorites.length})
              </button>
            ` : ''}
            <button
              onclick="window.setFilter('severe')"
              class="px-5 py-2 rounded-full font-medium whitespace-nowrap transition-all ${
                filter === 'severe' ? 'bg-red-500 text-white' : 'bg-blue-800 hover:bg-blue-700'
              }"
            >
              üî¥ Severe (${severeCount})
            </button>
            <button
              onclick="window.setFilter('moderate')"
              class="px-5 py-2 rounded-full font-medium whitespace-nowrap transition-all ${
                filter === 'moderate' ? 'bg-yellow-500 text-yellow-900' : 'bg-blue-800 hover:bg-blue-700'
              }"
            >
              üü° Moderate (${moderateCount})
            </button>
            <button
              onclick="window.setFilter('normal')"
              class="px-5 py-2 rounded-full font-medium whitespace-nowrap transition-all ${
                filter === 'normal' ? 'bg-green-500 text-green-900' : 'bg-blue-800 hover:bg-blue-700'
              }"
            >
              üü¢ Normal (${airports.length - severeCount - moderateCount})
            </button>
          </div>
        </div>

        <!-- Content -->
        <div class="max-w-4xl mx-auto px-6 pb-24">
          ${error ? `
            <div class="bg-red-900 border border-red-700 rounded-2xl p-4 mb-4 flex items-center gap-3">
              <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>${error}</span>
            </div>
          ` : ''}

          ${loading && airports.length === 0 ? `
            <div class="flex items-center justify-center py-12">
              <svg class="w-8 h-8 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </div>
          ` : filteredAirports.length === 0 ? `
            <div class="text-center py-12">
              <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              <p class="text-blue-300 text-lg">No airports found</p>
              ${searchQuery ? `<p class="text-blue-400 text-sm mt-2">Try a different search term</p>` : ''}
            </div>
          ` : `
            <div class="space-y-3">
              ${filteredAirports.map((airport) => {
                const severity = getSeverity(airport);
                const isFavorite = favorites.includes(airport.IATA);
                const wx = weather[airport.IATA];
                
                return `
                <div class="bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl p-5 shadow-lg hover:shadow-xl transition-all ${
                  severity === 'severe' ? 'ring-2 ring-red-500' : 
                  severity === 'moderate' ? 'ring-2 ring-yellow-500' : ''
                }">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <button
                          onclick="window.toggleFavorite('${airport.IATA}')"
                          class="text-2xl hover:scale-110 transition-transform"
                        >
                          ${isFavorite ? '‚≠ê' : '‚òÜ'}
                        </button>
                        <h3 class="text-2xl font-bold">${airport.IATA}</h3>
                      </div>
                      ${airport.name ? `<p class="text-blue-300 text-sm ml-9">${airport.name}</p>` : ''}
                      
                      ${wx ? `
                        <div class="flex items-center gap-4 mt-2 ml-9 text-sm text-blue-300">
                          <span>${getWeatherDescription(wx.code)}</span>
                          <span>üå°Ô∏è ${wx.temp}¬∞F</span>
                          <span>üí® ${wx.wind} mph</span>
                        </div>
                      ` : ''}
                    </div>
                    <div class="px-3 py-1 rounded-full text-xs font-semibold ${
                      severity === 'severe'
                        ? 'bg-red-500 text-white'
                        : severity === 'moderate'
                        ? 'bg-yellow-500 text-yellow-900'
                        : 'bg-green-500 text-green-900'
                    }">
                      ${severity === 'severe' ? 'üî¥ SEVERE' : 
                        severity === 'moderate' ? 'üü° DELAYS' : 'üü¢ NORMAL'}
                    </div>
                  </div>

                  ${airport.status ? `
                    <div class="space-y-2 text-sm">
                      ${airport.status.avgDelay ? `
                        <div class="flex justify-between items-center bg-blue-950 rounded-lg p-3">
                          <span class="text-blue-300">Average Delay</span>
                          <span class="font-semibold">${airport.status.avgDelay}</span>
                        </div>
                      ` : ''}
                      ${airport.status.groundDelay ? `
                        <div class="flex justify-between items-center bg-blue-950 rounded-lg p-3">
                          <span class="text-blue-300">Ground Delay</span>
                          <span class="font-semibold">${airport.status.groundDelay}</span>
                        </div>
                      ` : ''}
                      ${airport.status.groundStop ? `
                        <div class="flex justify-between items-center bg-red-950 rounded-lg p-3">
                          <span class="text-red-300">‚õî Ground Stop</span>
                          <span class="font-semibold">${airport.status.groundStop}</span>
                        </div>
                      ` : ''}
                      ${airport.status.closureBegin ? `
                        <div class="bg-red-950 rounded-lg p-3">
                          <div class="flex justify-between items-center mb-1">
                            <span class="text-red-300">üö´ Closure Begin</span>
                            <span class="font-semibold">${airport.status.closureBegin}</span>
                          </div>
                          ${airport.status.closureEnd ? `
                            <div class="flex justify-between items-center">
                              <span class="text-red-300">Closure End</span>
                              <span class="font-semibold">${airport.status.closureEnd}</span>
                            </div>
                          ` : ''}
                        </div>
                      ` : ''}
                      ${airport.status.reason ? `
                        <div class="bg-blue-950 rounded-lg p-3">
                          <span class="text-blue-300 text-xs">Reason: </span>
                          <span class="text-sm">${airport.status.reason}</span>
                        </div>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              `}).join('')}
            </div>
          `}
        </div>

        <!-- Bottom Action Bar -->
        <div class="fixed bottom-0 left-0 right-0 bg-blue-950 border-t border-blue-800 shadow-2xl">
          <div class="max-w-4xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between text-sm">
              <div class="text-blue-300">
                Showing ${filteredAirports.length} of ${airports.length} airports
              </div>
              <div class="text-blue-400 text-xs">
                Auto-refresh: 60s
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.refreshData = fetchNASData;
    window.setFilter = (newFilter) => {
      filter = newFilter;
      render();
    };
    window.setSearch = (query) => {
      searchQuery = query;
      render();
    };
    window.toggleFavorite = toggleFavorite;

    // Initial fetch
    fetchNASData();

    // Auto-refresh every 60 seconds
    setInterval(fetchNASData, 60000);
  </script>
</body>
</html>
